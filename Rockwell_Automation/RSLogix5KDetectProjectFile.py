# RSLogix5KDetectProjectFile.py
# Copyright (C) 2021 Alex Holburn https://www.alexholburn.com
# See the file 'docs/LICENSE' for copying permission.

# Script Purpose: This script is a Cuckoo Sandbox signature designed to detect is RSLogix 5000
#                 or Studio 5000 generated files are being accessed. Malware exhibiting this
#                 behavior would be indicative of ICS Reconnaissance to determine if an engineering
#                 workstation or file repository is interacting with the CompactLogix or ControlLogix
#                 PLC platform. Additionally it may indicate targeting specific filetypes for information
#                 theft/ransoming.

# I am looking to transition into Cybersecurity, contact me if you like my work.
# email: alex.holburn@alexholburn.com
# LinkedIn: https://www.linkedin.com/in/alex-holburn-88884b5b/
# Portfolio:  https://www.alexholburn.com


from lib.cuckoo.common.abstracts import Signature


class RSLogix5KDetectProjectFile(Signature):
    name = "RSLogix5k_detectProjectFile"
    description = "Attempts to Access RSLogix/Studio 5000 Project Files"
    severity = 2
    categories = ["Rockwell Automation ICS Reconnaissance"]
    authors = ["Alex Holburn"]
    minimum = "2.0"
    ttp = ["T0811"]


file_indicators = [
        ".*\\.acd$",      # RSLogix/Studio 5000 Project File extension lowercase variant.
        ".*\\.ACD$",      # RSLogix/Studio 5000 Project File extension uppercase variant.
        ".*\\_bak*.acd$"  # RSLogix/Studio 5000 Automatic Project Backup File extension lowercase variant.
        ".*\\_BAK*.ACD$"  # RSLogix/Studio 5000 Automatic Project Backup File extension uppercase variant.
        ".*\\.asc$",      # RSLogix/Studio 5000 Source Control Association File extension lowercase variant.
        ".*\\.ASC$",      # RSLogix/Studio 5000 Source Control Association File extension uppercase variant.
        ".*\\.l5k$",      # RSLogix/Studio 5000 Import/Export File extension lowercase variant.
        ".*\\.L5K$",      # RSLogix/Studio 5000 Import/Export File extension uppercase variant.
        ".*\\.l5x$",      # RSLogix/Studio 5000 XML Import/Export File extension lowercase variant.
        ".*\\.L5X$",      # RSLogix/Studio 5000 XML Import/Export File extension uppercase variant.
        ".*\\.wrk$",      # RSLogix/Studio 5000 Temporary Working File extension lowercase variant.
        ".*\\.WRK$",      # RSLogix/Studio 5000 Temporary Working File extension uppercase variant.
        ".*\\.sem$",      # RSLogix/Studio 5000 Temporary Working File extension lowercase variant.
        ".*\\.SEM$",      # RSLogix/Studio 5000 Temporary Working File extension uppercase variant.
        ".*\\.tbs$",      # RSLogix/Studio 5000 Export Trend Log File extension lowercase variant.
        ".*\\.TBS$",      # RSLogix/Studio 5000 Export Trend Log File extension uppercase variant.
        ".*\\.dbf$",      # RSLogix/Studio 5000 TrendX Chart Snapshot File extension lowercase variant.
        ".*\\.DBF$",      # RSLogix/Studio 5000 TrendX Chart Snapshot File extension uppercase variant.
        ".*\\.tem$",      # RSLogix/Studio 5000 TrendX Template File extension lowercase variant.
        ".*\\.TEM$",      # RSLogix/Studio 5000 TrendX Template File extension uppercase variant.
        ".*\\.pf5$",      # RSLogix/Studio 5000 Controller Memory Image File extension lowercase variant.
        ".*\\.PF5$",      # RSLogix/Studio 5000 Controller Memory Image File extension uppercase variant.
    ]


def on_complete(self):
    for indicator in self.file_indicators:
        for match in self.check_file(pattern=indicator, regex=True, all=True):
            self.mark_ioc("file", match)

        return self.has_marks()
