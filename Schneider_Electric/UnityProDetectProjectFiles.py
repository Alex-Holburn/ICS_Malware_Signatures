# UnityProDetectProjectFiles.py
# Copyright (C) 2021 Alex Holburn https://www.alexholburn.com
# See the file 'docs/LICENSE' for copying permission.

# Script Purpose: This script is a Cuckoo Sandbox signature designed to detect if UnityPro
#                 generated files are being accessed. Malware exhibiting this behavior would
#                 be indicative of ICS Reconnaissance to determine if an engineering workstation
#                 or file repository is interacting with the EcoStructure or Unity Pro PLC
#                 platform. Additionally it may indicate targeting specific filetypes for information
#                 theft/ransoming.

# I am looking to transition into Cybersecurity, contact me if you like my work.
# email: alex.holburn@alexholburn.com
# LinkedIn: https://www.linkedin.com/in/alex-holburn-88884b5b/
# Portfolio:  https://www.alexholburn.com


from lib.cuckoo.common.abstracts import Signature


class UnityProDetectProjectFile(Signature):
    name = "UnityPro_detectProjectFile"
    description = "Attempts to Access Unity Pro Project Files"
    severity = 2
    categories = ["Schneider Electric ICS Reconnaissance"]
    authors = ["Alex Holburn"]
    minimum = "2.0"
    ttp = ["T0811"]


file_indicators = [
        ".*\\.stu$",      # EcoStructure/Unity Pro Working File extension lowercase variant.
        ".*\\.STU$",      # EcoStructure/Unity Pro Working File extension uppercase variant.
        ".*\\.sta$"       # EcoStructure/Unity Pro Archive File extension lowercase variant.
        ".*\\.STA$"       # EcoStructure/Unity Pro Archive File extension uppercase variant.
        ".*\\.stm$",      # EcoStructure/Unity Pro Binary/Executable File extension lowercase variant.
        ".*\\.STM$",      # EcoStructure/Unity Pro Binary/Executable File extension uppercase variant.
        ".*\\.xef$",      # EcoStructure/Unity Pro "Openness" XML File extension lowercase variant.
        ".*\\.XEF$",      # EcoStructure/Unity Pro "Openness" XML File File extension uppercase variant.
        ".*\\.zef$",      # EcoStructure/Unity Pro XEF + DTM Configuration Source File extension lowercase variant.
        ".*\\.ZEF$",      # EcoStructure/Unity Pro XEF + DTM Configuration Source File extension uppercase variant.
    ]


def on_complete(self):
    for indicator in self.file_indicators:
        for match in self.check_file(pattern=indicator, regex=True, all=True):
            self.mark_ioc("file", match)

        return self.has_marks()
