# TwinCATProjectFiles.py
# Copyright (C) 2021 Alex Holburn https://www.alexholburn.com
# See the file 'docs/LICENSE' for copying permission.

# Script Purpose: This script is a Cuckoo Sandbox signature designed to detect if UnityPro
#                 generated files are being accessed. Malware exhibiting this behavior would
#                 be indicative of ICS Reconnaissance to determine if an engineering workstation
#                 or file repository is interacting with the EcoStructure or Unity Pro PLC
#                 platform. Additionally it may indicate targeting specific filetypes for information
#                 theft/ransoming.

# I am looking to transition into Cybersecurity, contact me if you like my work.
# email: alex.holburn@alexholburn.com
# LinkedIn: https://www.linkedin.com/in/alex-holburn-88884b5b/
# Portfolio:  https://www.alexholburn.com


from lib.cuckoo.common.abstracts import Signature


class TwinCATDetectProjectFile(Signature):
    name = "TwinCAT_detectProjectFile"
    description = "Attempts to Access TwinCAT Project Files"
    severity = 2
    categories = ["Beckhoff ICS Reconnaissance"]
    authors = ["Alex Holburn"]
    minimum = "2.0"
    ttp = ["T0811"]


file_indicators = [
        ".*\\.tsproj$",      # TwinCAT IDE Project File extension.
        ".*\\.plcproj$",     # TwinCAT PLC Project File extension.
        ".*\\.tmc$",         # TwinCAT Module Class File extension.
        ".*\\.tpy$",         # TwinCAT Vendor Compatibility File extension.
        ".*\\.tmc$",         # TwinCAT "multiple file support" File extension.
        ".*\\.TcTTO$",       # TwinCAT PLC Task Object File extension.
        ".*\\.TcPOU$",       # TwinCAT PLC Program Organizational Unit File extension.
        ".*\\.TcDUT$",       # TwinCAT PLC Data Type File extension.
        ".*\\.TcGVL$",       # TwinCAT PLC Global Variable List File extension.
        ".*\\.TcVis$",       # TwinCAT PLC Visualization File extension.
        ".*\\.TcVMO$",       # TwinCAT PLC Visualization Manager File extension.
        ".*\\.TcGTLO$",      # TwinCAT PLC Global Text List File extension.
        ".*\\.sln$",         # Visual Studio Solution File extension.
        ".*\\.sln$",         # Visual Studio user options File extension.
    ]


def on_complete(self):
    for indicator in self.file_indicators:
        for match in self.check_file(pattern=indicator, regex=True, all=True):
            self.mark_ioc("file", match)

        return self.has_marks()
